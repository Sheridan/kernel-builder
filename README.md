# Gentoo Kernel Builder

## Описание

Этот проект — инструмент для автоматизации сборки, конфигурирования и установки ядра Linux в дистрибутиве Gentoo c поддержкой избыточной установки на несколько загрузочных флешек.
Скрипт написан на Python 3 с использованием объектно-ориентированного подхода.

Основные возможности:
- Интерактивное конфигурирование ядра с сохранением резервных копий .config
- Сборка ядра, модулей и initramfs (genkernel)
- Переименование файлов ядра и initramfs с добавлением даты/времени (для правильной сортировки в grub)
- Автоматическая установка ядра на несколько флешек (по списку из конфигурационного файла)
- Обновление grub.cfg на каждой флешке после установки
- Вся логика реализована в одном исполняемом файле и управляется аргументами командной строки

> **Внимание:**
> Для выполнения операций требуются root-права.

---

## Пример конфигурационного файла (`kernel_builder.json`)

```json
{
  "linux_dir": "/usr/src/linux",
  "backup_config_dir": "/usr/src/kernel_configs_backup",
  "boot_mountpoint": "/boot",
  "initramfs_args": ["--btrfs", "--no-zfs", "--no-lvm", "--no-dmraid", "--no-luks"],
  "build_jobs": 8,
  "flash_devices": [
    { "device": "/dev/disk/by-id/usb-_USB_DISK_2.0_9000736584240B87-0:0", "partition": "-part1" },
    { "device": "/dev/disk/by-id/usb-UFD_2.0_Silicon-Power4G_201210SP0069070D2B166F327E21-0:0", "partition": "-part1" }
  ]
}
```

**Пояснения к полям:**
- `linux_dir` — путь к исходникам ядра (симлинк на текущую версию)
- `backup_config_dir` — каталог для хранения резервных копий .config
- `boot_mountpoint` — точка монтирования /boot (должна существовать)
- `initramfs_args` — аргументы для `genkernel`
- `build_jobs` — количество потоков для сборки
- `flash_devices` — список флешек, каждая с параметрами:
  - `device` — путь к блочному устройству (например, через /dev/disk/by-id)
  - `partition` — суффикс раздела (например, `-part1` для `device-part1`)

---

## Использование

1. **Создайте конфиг:**
   Скопируйте и адаптируйте файл `kernel_builder.json` под свои устройства и пути.

2. **Запустите скрипт с нужной командой:**

```sh
sudo ./kernel_builder.py configure   # Открыть nconfig, сделать резервную копию .config
sudo ./kernel_builder.py build       # Собрать ядро, initramfs, переименовать файлы, обновить grub на основном /boot
sudo ./kernel_builder.py install     # Поочередно установить ядро на все флешки из конфигурации
```

- По умолчанию используется `kernel_builder.json` в текущей директории.
- Для использования другого файла конфига:
  ```sh
  sudo ./kernel_builder.py build -c /path/to/yourconfig.json
  ```

3. **Описание команд:**
- `configure` — запуск `make nconfig` с бэкапом текущего .config
- `build` — сборка ядра, модулей, initramfs, переименование файлов, обновление grub на основном диске
- `install` — поочередная установка ядра на все указанные флешки с обновлением grub на каждой из них

---

## Примечания

- Для работы требуются утилиты: `make`, `genkernel`, `grub-mkconfig`, а также права суперпользователя.
- Все действия логируются в stdout.
- Перед использованием убедитесь, что корректно смонтированы нужные разделы и указаны правильные устройства.
